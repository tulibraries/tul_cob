version: 2.1

orbs:
  ruby: circleci/ruby@2.0.0
  coveralls: coveralls/coveralls@1.0.6
  browser-tools: circleci/browser-tools@1.4.6

workflows:
  version: 2
  run_tests:
    jobs:
      - run_tests
  qa_deploy:
   jobs:
     - qa_deploy:
         filters:
           branches:
             only:
               - main
jobs:
  run_tests:
    docker:
      - image: cimg/ruby:3.1-browsers
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout

      - restore_cache:
          keys:
            - gem-cache-v9-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
            - gem-cache-v9-{{ arch }}-{{ .Branch }}
            - gem-cache-v9-{{ arch }}
            - yarn-cache-v9-{{ arch }}-{{ .Branch }}-{{ checksum "yarn.lock" }}

      - setup_remote_docker:
          docker_layer_caching: false
          version: 20.10.11

      - run: if [ -e /var/run/docker.sock ]; then sudo chown circleci:circleci /var/run/docker.sock; fi

      - run:
          name: Build app
          command: make up

      - run:
          name: Run bundler on the app container
          command: make ci-bundle-install

      - run:
          name: Run yarn install on the app container
          command: make ci-yarn-install

      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - checkout
      - run:
          name: Check install
          command: |
            google-chrome --version
            chromedriver --version

      - run:
          name: Copy the vendor/bundle from the container to local
          command: make ci-copy-bundle-files-to-local

      - run:
          name: Copy the node_modules from the container to local
          command: make ci-copy-node-modules-to-local

      - save_cache:
          key: gem-cache-v9-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
          paths:
              - vendor/bundle

      - save_cache:
          key: yarn-cache-v9-{{ arch }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
              - node_modules

      - run:
          name: Set up DB
          command: make ci-setup-db

      - run:
          name: Run linter
          command: make lint

      - run:
          name: Run ruby tests
          command: |
            make test
            docker cp tul_cob-app-1:/app/coverage/lcov/app.lcov ./app.lcov

      - run:
          name: Run javascript tests
          command: make test-js

      - coveralls/upload:
          path_to_lcov: ./app.lcov

  qa_deploy:
    docker:
      - image: cimg/python:3.9.10
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
        environment:
          PIPENV_VENV_IN_PROJECT: true
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "f7:95:df:23:81:5e:03:3e:73:0f:de:6f:1d:47:be:96"
      - run:
          command: bash .circleci/deploy-qa.sh
